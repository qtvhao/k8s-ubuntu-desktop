#!/bin/bash

set -xeo pipefail

google-chrome-stable \
    --user-data-dir=/data \
    --no-sandbox \
    --remote-debugging-port=21222 \
    --disable-gpu \
    --disable-dev-shm-usage \
    --disable-software-rasterizer \
    --disable-setuid-sandbox \
    --no-first-run \
    --disable-proxy-certificate-handler \
    --no-zygote &

while true; do
    sleep 1
    curl -s http://localhost:21222/json | jq -e '.[] | select(.type == "page")' && break || true
done

curl -s http://localhost:21222/json | jq -e '.[] | select(.type == "page") | .title'

while true; do
    sleep 18
    timeout 1 curl -s http://localhost:21222/json | jq -e '.[] | select(.type == "page") | .title'
done
